let workerId="";const SSE={},retryTimeout=5e3,retryLimit=3,_log=a=>postMessage({workerId,log:a}),_resolve=a=>postMessage({workerId,resolve:a}),_reject=a=>postMessage({workerId,reject:a});onerror=(a,b,c,d,e)=>postMessage({workerId,error:e}),onmessage=a=>{workerId=a.data.id,SSE?.[workerId]?.close();const{handle:b,formData:c,logStart:d,urlData:e,nonce:f,logMessages:g}=a.data.data,h=new URL(e.endpoint,e.base);h.searchParams.set("action","tsfem_e_transport"),h.searchParams.set("handle",b),h.searchParams.set("nonce",f),h.searchParams.set("data",c);let i=0,j=1;const k=()=>{h.searchParams.set("retryAllowed",j),SSE[workerId]=new EventSource(h.href),SSE[workerId].onopen=a=>{_log(d,1)},SSE[workerId].onerror=a=>{SSE[workerId].close(),_log(g.unknownErrorFull,2),_reject(g.unknownError)};const a=a=>{try{return JSON.parse(a)}catch(a){return}},b=b=>{SSE[workerId].close();const c=a(b.data);_log("&nbsp;"),_log(c?.logMsg,2),_resolve(c?.results.notice)},c=c=>{if(i++,_log("===============",1),i>retryLimit)return _log(g.retryLimitReached),b(c);j=i<retryLimit?1:0,SSE[workerId].close(),_log(a(c.data)?.logMsg,1);let d=1;const e=setInterval(()=>{const a=retryTimeout/1e3-d++,b=2>a;_log(g.retryCountdown.replace("%d",a),b?1:0),b&&clearInterval(e)},1e3);setTimeout(k,retryTimeout)};SSE[workerId].addEventListener("tsfem-e-transport-log",b=>{_log(a(b.data)?.content)}),SSE[workerId].addEventListener("tsfem-e-transport-done",b=>{SSE[workerId].close();const c=a(b.data);_log("\n\n"+c.logMsg,2),_resolve(c?.results.notice)}),SSE[workerId].addEventListener("tsfem-e-transport-failure",b),SSE[workerId].addEventListener("tsfem-e-transport-locked",b),SSE[workerId].addEventListener("tsfem-e-transport-crash",c),SSE[workerId].addEventListener("tsfem-e-transport-timeout",c),SSE[workerId].addEventListener("tsfem-e-transport-die",b=>{_log("==============="),_log("&nbsp;"),_log(a(b.data)?.content),_log("&nbsp;"),_log("===============",1)})};k()};
